<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A lightweight, browser-based inventory management system for tracking stock items with names, quantities, and images.">
    <title>Stock Management</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.0/flowbite.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.0/flowbite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        :root {
            --primary-color: #5D5CDE;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #181818;
                --text-color: #ffffff;
                --card-bg: #2d2d2d;
                --input-bg: #3d3d3d;
            }
        }
        
        @media (prefers-color-scheme: light) {
            :root {
                --bg-color: #ffffff;
                --text-color: #333333;
                --card-bg: #f5f5f5;
                --input-bg: #ffffff;
            }
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .item-card {
            background-color: var(--card-bg);
        }
        
        .custom-file-upload {
            display: inline-block;
            padding: 8px 16px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            border-radius: 0.375rem;
            transition: background-color 0.3s;
        }
        
        .custom-file-upload:hover {
            background-color: #4b4abf;
        }
        
        /* Highlighted Add Item button */
        #add-item-form button[type="submit"] {
            position: relative;
            overflow: hidden;
            border: 2px solid #4b4abf;
            transition: all 0.3s ease;
            transform: translateY(0);
            box-shadow: 0 4px 6px rgba(93, 92, 222, 0.25);
        }
        
        #add-item-form button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(93, 92, 222, 0.3);
        }
        
        #add-item-form button[type="submit"]::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            bottom: -50%;
            left: -50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.1) 100%);
            transform: rotateZ(60deg) translate(-5em, 7.5em);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% {
                transform: rotateZ(60deg) translate(-5em, 7.5em);
            }
            100% {
                transform: rotateZ(60deg) translate(1em, -9em);
            }
        }
        
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .image-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e2e2e2;
            color: #666;
            font-size: 14px;
        }
        
        .image-preview {
            object-fit: cover;
            width: 100%;
            height: 100%;
        }
        
        /* Animation for new items */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .new-item {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Animation for quantity change */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .quantity-changed {
            animation: pulse 0.3s ease-out;
            color: var(--primary-color);
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .toast-error {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        
        .toast-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .toast-info {
            background-color: #e0f7ff;
            color: #0369a1;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: var(--bg-color);
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        
        .action-button-container {
            background-color: var(--card-bg);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            margin-top: 16px;
            border-radius: 0 0 8px 8px;
        }

        /* Cloud sync indicator */
        .sync-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .sync-online {
            background-color: #d1fae5;
            color: #065f46;
        }

        .sync-offline {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .sync-syncing {
            background-color: #fef3c7;
            color: #92400e;
        }

        /* Sync setup modal */
        .sync-setup-container {
            margin-top: 16px;
        }

        .sync-setup-container input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .sync-id-display {
            background-color: #f1f5f9;
            padding: 8px;
            border-radius: 6px;
            font-family: monospace;
            margin-bottom: 12px;
            word-break: break-all;
        }

        /* Export/Sync panel */
        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 1rem;
        }

        .tab-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .copy-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            background-color: #e5e7eb;
            color: #1f2937;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .copy-btn:hover {
            background-color: #d1d5db;
        }

        .copy-btn svg {
            width: 1rem;
            height: 1rem;
            margin-right: 0.25rem;
        }

        .data-input {
            width: 100%;
            height: 120px;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <h1 class="text-3xl font-bold mb-2 text-center">Stock Management</h1>
        <div class="flex justify-center items-center mb-6">
            <div id="sync-status" class="sync-status sync-offline">
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" transform="rotate(180, 10, 10)"></path>
                </svg>
                Offline
            </div>
        </div>
        
        <!-- Add Item Form -->
        <div class="mb-8 p-6 rounded-lg shadow-md item-card">
            <h2 class="text-xl font-semibold mb-4">Add New Item</h2>
            <form id="add-item-form" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label for="item-name" class="block mb-2 text-sm font-medium">Item Name</label>
                        <input type="text" id="item-name" class="bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white text-base rounded-lg focus:ring-primary focus:border-primary block w-full p-3" placeholder="Enter item name" required>
                    </div>
                    
                    <div>
                        <label for="item-quantity" class="block mb-2 text-sm font-medium">Quantity</label>
                        <input type="number" id="item-quantity" min="0" class="bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white text-base rounded-lg focus:ring-primary focus:border-primary block w-full p-3" placeholder="Enter quantity" required>
                    </div>
                </div>
                
                <div>
                    <label class="block mb-2 text-sm font-medium">Item Image</label>
                    <div class="flex items-center space-x-4">
                        <div id="image-preview-container" class="h-24 w-24 rounded-lg overflow-hidden image-placeholder">
                            <span>Preview</span>
                        </div>
                        <div>
                            <label for="item-image" class="custom-file-upload">
                                <svg class="w-4 h-4 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                                </svg>
                                Upload Image
                            </label>
                            <input type="file" id="item-image" accept="image/*">
                            <p class="text-xs mt-1 text-gray-500 dark:text-gray-400">Optional. PNG, JPG or GIF</p>
                            <p id="image-size-warning" class="text-xs mt-1 text-red-500 hidden">Warning: Large images may cause storage issues</p>
                        </div>
                    </div>
                </div>
                
                <div class="action-button-container bg-gray-50 dark:bg-gray-800 rounded-lg p-4 mt-6">
                    <button type="submit" class="w-full px-5 py-3 text-base font-medium text-center text-white bg-[var(--primary-color)] rounded-lg hover:bg-[#4b4abf] focus:ring-4 focus:outline-none focus:ring-blue-300 transition flex items-center justify-center">
                        <span id="loading-indicator" class="hidden">
                            <span class="loader"></span>
                        </span>
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add Item to Inventory
                    </button>
                    <div class="mt-2 text-sm text-center text-gray-500">Fill out the form above and click this button to add a new item</div>
                </div>
            </form>
        </div>
        
        <!-- Storage Info -->
        <div id="storage-info" class="mb-4 p-4 rounded-lg bg-blue-50 text-blue-800 flex items-center hidden">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1v-3a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
            <div>
                <span class="font-medium">Storage Information:</span>
                <div class="text-sm mt-1">
                    <div>Used: <span id="storage-used">0 KB</span> of <span id="storage-quota">5 MB</span></div>
                    <div class="w-full bg-blue-200 rounded-full h-2 mt-1">
                        <div id="storage-bar" class="bg-blue-800 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Inventory Display -->
        <div class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                <h2 class="text-xl font-semibold">Current Inventory</h2>
                <div class="flex flex-col md:flex-row items-start md:items-center gap-2">
                    <div id="storage-status" class="text-xs font-medium px-3 py-1 bg-yellow-100 text-yellow-800 rounded-md flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        Checking storage...
                    </div>
                    <div id="item-count" class="text-sm font-medium px-3 py-1 bg-[var(--primary-color)] text-white rounded-full">
                        0 items
                    </div>
                </div>
            </div>
            
            <div id="no-items-message" class="text-center py-8 item-card rounded-lg">
                <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                </svg>
                <p class="mt-4 text-gray-500 dark:text-gray-400">Your inventory is empty. Add items to get started.</p>
            </div>
            
            <div id="inventory-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Items will be added here dynamically -->
            </div>
        </div>
        
        <!-- Tools -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Tools</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <button id="export-data" class="p-4 rounded-lg shadow-md bg-green-100 text-green-800 hover:bg-green-200 transition flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    Export Data
                </button>
                
                <div class="relative">
                    <input type="file" id="import-file" class="hidden" accept=".json">
                    <button id="import-data" class="p-4 w-full rounded-lg shadow-md bg-blue-100 text-blue-800 hover:bg-blue-200 transition flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" transform="rotate(180, 10, 10)"></path>
                        </svg>
                        Import Data
                    </button>
                </div>
                
                <button id="share-data" class="p-4 rounded-lg shadow-md bg-purple-100 text-purple-800 hover:bg-purple-200 transition flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M5.5 16a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 16h-8z" clip-rule="evenodd"></path>
                    </svg>
                    Share Data
                </button>
                
                <button id="clear-data" class="p-4 rounded-lg shadow-md bg-red-100 text-red-800 hover:bg-red-200 transition flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    Clear All Data
                </button>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="text-center text-gray-500 text-sm mt-8 pb-6">
            <p>Stock Management App &copy; 2023</p>
            <p class="mt-1">
                <a href="https://github.com/yourusername/stock-management" target="_blank" class="text-[var(--primary-color)] hover:underline">View on GitHub</a>
            </p>
        </footer>
    </div>

    <script>
        // Constants
        const MAX_LOCALSTORAGE_SIZE = 5 * 1024 * 1024; // 5MB approximate limit
        const IMAGE_QUALITY = 0.7; // JPEG compression quality
        const MAX_IMAGE_DIMENSION = 800; // Maximum width or height for images
        const STORAGE_KEY = 'stockInventory';
        const MAX_RETRIES = 3; // Maximum number of API call retries

        // State
        let inventory = [];
        let storageAvailable = false;
        let toastTimeout = null;

        // DOM Elements
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize the app
            loadInventory();
            setupEventListeners();
            updateStorageInfo();
        });

        // Fetch with retry functionality
        const fetchWithRetry = async (url, options = {}, maxRetries = MAX_RETRIES) => {
            let lastError = null;
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    // Attempt the fetch request
                    const response = await fetch(url, options);
                    
                    // If response is not ok, throw an error
                    if (!response.ok) {
                        let errorMessage = `HTTP error! Status: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            if (errorData && errorData.error) {
                                errorMessage = errorData.error;
                            }
                        } catch (e) {
                            // If we can't parse the error as JSON, just use the default message
                        }
                        throw new Error(errorMessage);
                    }
                    
                    // Return the successful response
                    return response;
                } catch (error) {
                    console.warn(`Attempt ${attempt + 1} failed: ${error.message}`);
                    lastError = error;
                    
                    // Calculate exponential backoff delay: 2^attempt * 100ms
                    const delay = Math.min(Math.pow(2, attempt) * 100, 2000);
                    
                    // Wait before retrying
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            // If all retries failed, throw the last error
            throw new Error(`Failed after ${maxRetries} attempts: ${lastError ? lastError.message : 'Unknown error'}`);
        };

        // Check if storage is available
        const checkStorageAvailability = () => {
            try {
                const testKey = '__storage_test__';
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
                return true;
            } catch (e) {
                return false;
            }
        };

        // Get storage usage information
        const getStorageInfo = () => {
            if (!storageAvailable) return { used: 0, quota: 0, percentage: 0 };
            
            let used = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                used += (key.length + value.length) * 2; // UTF-16 characters are 2 bytes each
            }
            
            return {
                used,
                quota: MAX_LOCALSTORAGE_SIZE,
                percentage: (used / MAX_LOCALSTORAGE_SIZE) * 100
            };
        };

        // Update storage info display
        const updateStorageInfo = () => {
            const storageInfo = document.getElementById('storage-info');
            const storageUsed = document.getElementById('storage-used');
            const storageQuota = document.getElementById('storage-quota');
            const storageBar = document.getElementById('storage-bar');
            
            if (!storageAvailable) {
                storageInfo.classList.add('hidden');
                return;
            }
            
            const info = getStorageInfo();
            
            // Format sizes for display
            const usedFormatted = info.used < 1024 ? 
                `${info.used} B` : 
                info.used < 1024 * 1024 ? 
                    `${(info.used / 1024).toFixed(1)} KB` : 
                    `${(info.used / (1024 * 1024)).toFixed(1)} MB`;
                    
            const quotaFormatted = `${(info.quota / (1024 * 1024)).toFixed(0)} MB`;
            
            // Update display
            storageUsed.textContent = usedFormatted;
            storageQuota.textContent = quotaFormatted;
            storageBar.style.width = `${Math.min(info.percentage, 100)}%`;
            
            // Set bar color based on usage
            if (info.percentage > 90) {
                storageBar.classList.remove('bg-blue-800', 'bg-yellow-500');
                storageBar.classList.add('bg-red-600');
            } else if (info.percentage > 70) {
                storageBar.classList.remove('bg-blue-800', 'bg-red-600');
                storageBar.classList.add('bg-yellow-500');
            } else {
                storageBar.classList.remove('bg-yellow-500', 'bg-red-600');
                storageBar.classList.add('bg-blue-800');
            }
            
            // Show storage info
            storageInfo.classList.remove('hidden');
            
            // Show warning if close to limit
            if (info.percentage > 85) {
                showToast('Warning: Running low on storage space. Consider exporting and clearing data.', 'warning');
            }
        };

        // Load inventory from storage
        const loadInventory = () => {
            storageAvailable = checkStorageAvailability();
            
            if (storageAvailable) {
                try {
                    const storedInventory = localStorage.getItem(STORAGE_KEY);
                    if (storedInventory) {
                        inventory = JSON.parse(storedInventory);
                    }
                    showStorageStatus(true);
                } catch (error) {
                    console.error('Error loading from storage:', error);
                    showStorageStatus(false, 'Error loading data');
                }
            } else {
                showStorageStatus(false);
            }
            
            updateInventoryDisplay();
        };

        // Save inventory to storage
        const saveInventory = () => {
            if (storageAvailable) {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(inventory));
                    showStorageStatus(true, 'Data saved');
                    updateStorageInfo();
                } catch (error) {
                    console.error('Error saving to storage:', error);
                    if (error.name === 'QuotaExceededError' || error.code === 22) {
                        showStorageStatus(false, 'Storage quota exceeded');
                        showToast('Storage quota exceeded. Try removing some items or images.', 'error');
                    } else {
                        showStorageStatus(false, 'Error saving data');
                    }
                }
            }
        };

        // Share data with text and QR code
        const shareData = () => {
            if (inventory.length === 0) {
                showToast('No inventory data to share', 'warning');
                return;
            }
            
            try {
                // Create a simplified version of inventory for sharing (without images)
                const simplifiedInventory = inventory.map(item => {
                    return {
                        id: item.id,
                        name: item.name,
                        quantity: item.quantity,
                        createdAt: item.createdAt
                    };
                });

                // Convert to JSON string and compress
                const dataJson = JSON.stringify(simplifiedInventory);
                const compressedData = LZString.compressToBase64(dataJson);
                
                // Create modal for sharing options
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                
                overlay.innerHTML = `
                    <div class="modal-content">
                        <h3 class="text-xl font-semibold mb-2">Share Inventory Data</h3>
                        <p class="mb-4">Here are different ways to share your inventory data with another device (without images):</p>
                        
                        <div class="tab-container">
                            <div class="tab active" data-tab="text">Text Code</div>
                            <div class="tab" data-tab="qr">QR Code</div>
                            <div class="tab" data-tab="import">Import</div>
                        </div>
                        
                        <div class="tab-content active" data-tab="text">
                            <p class="text-sm mb-2">Copy this code and paste it on another device:</p>
                            <textarea class="data-input" readonly>${compressedData}</textarea>
                            <button class="copy-btn" data-copy="${compressedData}">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" />
                                </svg>
                                Copy to Clipboard
                            </button>
                        </div>
                        
                        <div class="tab-content" data-tab="qr">
                            <p class="text-sm mb-2">Scan this QR code with another device:</p>
                            <div class="qr-code-container">
                                <div id="qrcode"></div>
                                <p class="mt-2 text-xs text-gray-500">Note: This QR code contains your inventory data without images.</p>
                                <button id="download-qr" class="px-4 py-2 mt-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                    Download QR
                                </button>
                            </div>
                        </div>
                        
                        <div class="tab-content" data-tab="import">
                            <p class="text-sm mb-2">Paste a code from another device:</p>
                            <textarea id="import-data-input" class="data-input" placeholder="Paste the code here..."></textarea>
                            <button id="import-data-btn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">
                                Import Data
                            </button>
                        </div>
                        
                        <div class="flex justify-end mt-4">
                            <button id="modal-close" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                // Add to DOM
                document.body.appendChild(overlay);
                
                // Trigger animation
                setTimeout(() => {
                    overlay.classList.add('show');
                }, 10);
                
                // Initialize QR code (but don't generate yet)
                let qrcode = null;
                
                // Set up tab functionality
                const tabs = document.querySelectorAll('.tab');
                const tabContents = document.querySelectorAll('.tab-content');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.getAttribute('data-tab');
                        
                        // Update active tab
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Update active content
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                            if (content.getAttribute('data-tab') === tabName) {
                                content.classList.add('active');
                                
                                // Generate QR code if tab is 'qr'
                                if (tabName === 'qr' && !qrcode) {
                                    try {
                                        // Try to generate QR code with error correction L (low)
                                        qrcode = generateQRCode(compressedData);
                                        document.getElementById('qrcode').innerHTML = qrcode;
                                    } catch (error) {
                                        console.error('Error generating QR code:', error);
                                        document.getElementById('qrcode').innerHTML = `
                                            <div class="p-4 bg-red-100 text-red-800 rounded-lg">
                                                <p>Could not generate QR code - data too large.</p>
                                                <p class="text-sm mt-2">Please use the Text Code method instead.</p>
                                            </div>
                                        `;
                                    }
                                }
                            }
                        });
                    });
                });
                
                // Set up event listeners
                const closeBtn = document.getElementById('modal-close');
                const copyBtn = document.querySelector('.copy-btn');
                const downloadBtn = document.getElementById('download-qr');
                const importDataBtn = document.getElementById('import-data-btn');
                
                const closeModal = () => {
                    overlay.classList.remove('show');
                    setTimeout(() => {
                        overlay.remove();
                    }, 300);
                };
                
                closeBtn.addEventListener('click', closeModal);
                
                copyBtn.addEventListener('click', () => {
                    const textToCopy = copyBtn.getAttribute('data-copy');
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => {
                            copyBtn.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                                </svg>
                                Copied!
                            `;
                            setTimeout(() => {
                                copyBtn.innerHTML = `
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" />
                                    </svg>
                                    Copy to Clipboard
                                `;
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Error copying text: ', err);
                            showToast('Failed to copy to clipboard', 'error');
                        });
                });
                
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', () => {
                        // Get QR code image
                        const qrImg = document.querySelector('#qrcode img');
                        if (!qrImg) return;
                        
                        // Create a canvas to add a margin and title
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const margin = 20;
                        const title = 'Stock Management Inventory';
                        
                        // Set canvas size
                        canvas.width = qrImg.width + (margin * 2);
                        canvas.height = qrImg.height + (margin * 2) + 40; // Extra height for title
                        
                        // Fill background
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // Add title
                        ctx.fillStyle = '#000000';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(title, canvas.width / 2, margin);
                        
                        // Draw QR code
                        ctx.drawImage(qrImg, margin, margin + 20);
                        
                        // Get data URL
                        const dataUrl = canvas.toDataURL('image/png');
                        
                        // Create link and trigger download
                        const link = document.createElement('a');
                        link.download = 'inventory_qr.png';
                        link.href = dataUrl;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    });
                }
                
                importDataBtn.addEventListener('click', () => {
                    const importText = document.getElementById('import-data-input').value.trim();
                    if (!importText) {
                        showToast('Please paste a valid data code', 'warning');
                        return;
                    }
                    
                    try {
                        // Decompress the data
                        const decompressedData = LZString.decompressFromBase64(importText);
                        const importedData = JSON.parse(decompressedData);
                        
                        if (!Array.isArray(importedData)) {
                            throw new Error('Invalid inventory data format');
                        }
                        
                        // Add imported items
                        let newItemCount = 0;
                        importedData.forEach(importedItem => {
                            // Check if item already exists (by ID)
                            const existingItemIndex = inventory.findIndex(item => item.id === importedItem.id);
                            
                            if (existingItemIndex === -1) {
                                // New item
                                inventory.push({
                                    ...importedItem,
                                    // Make sure it has required fields
                                    id: importedItem.id || generateId(),
                                    createdAt: importedItem.createdAt || new Date().toISOString()
                                });
                                newItemCount++;
                            } else {
                                // Update existing item (quantity only)
                                inventory[existingItemIndex].quantity = importedItem.quantity;
                            }
                        });
                        
                        // Save and update
                        saveInventory();
                        updateInventoryDisplay();
                        
                        closeModal();
                        showToast(`Imported ${newItemCount} new items successfully`, 'success');
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('Error importing data: Invalid or corrupted code', 'error');
                    }
                });
                
                showToast('Data sharing options ready', 'success');
            } catch (error) {
                console.error('Error sharing data:', error);
                showToast('Error preparing data for sharing', 'error');
            }
        };

        // Generate a QR code for the provided data
        const generateQRCode = (data) => {
            try {
                // Try with a higher version (10) for more data capacity
                const qr = qrcode(10, 'L'); // L = Low error correction (7%)
                qr.addData(data);
                qr.make();
                return qr.createImgTag(5);
            } catch (error) {
                console.error("Failed with version 10, trying version 20:", error);
                try {
                    // Try with an even higher version
                    const qr = qrcode(20, 'L');
                    qr.addData(data);
                    qr.make();
                    return qr.createImgTag(4);
                } catch (error2) {
                    console.error("Failed with version 20, trying with version 40 and minimal size:", error2);
                    try {
                        // Maximum version with minimum size
                        const qr = qrcode(40, 'L');
                        qr.addData(data);
                        qr.make();
                        return qr.createImgTag(2);
                    } catch (error3) {
                        console.error("Could not generate QR code with any version:", error3);
                        throw new Error("Data too large for QR code");
                    }
                }
            }
        };

        // Show storage status to user
        const showStorageStatus = (isAvailable, message = null) => {
            const storageStatus = document.getElementById('storage-status');
            
            if (isAvailable) {
                storageStatus.classList.remove('bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-red-800');
                storageStatus.classList.add('bg-green-100', 'text-green-800');
                storageStatus.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    ${message || 'Data will be saved automatically'}
                `;
                
                // If it's a temporary message, revert to default message after 2 seconds
                if (message && message !== 'Data will be saved automatically') {
                    setTimeout(() => {
                        if (storageAvailable) {
                            showStorageStatus(true);
                        }
                    }, 2000);
                }
            } else {
                storageStatus.classList.remove('bg-green-100', 'text-green-800');
                storageStatus.classList.add('bg-yellow-100', 'text-yellow-800');
                storageStatus.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    ${message || 'Storage unavailable - data will not be saved between sessions'}
                `;
                
                if (message && message.includes('quota')) {
                    storageStatus.classList.remove('bg-yellow-100', 'text-yellow-800');
                    storageStatus.classList.add('bg-red-100', 'text-red-800');
                }
            }
        };

        // Generate a unique ID
        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        };

        // Set up event listeners
        const setupEventListeners = () => {
            // Image preview
            const imageInput = document.getElementById('item-image');
            const previewContainer = document.getElementById('image-preview-container');
            const imageSizeWarning = document.getElementById('image-size-warning');
            
            imageInput?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) {
                    previewContainer.innerHTML = '<span>Preview</span>';
                    previewContainer.classList.add('image-placeholder');
                    imageSizeWarning.classList.add('hidden');
                    return;
                }
                
                // Check file size
                if (file.size > 2 * 1024 * 1024) { // 2MB
                    imageSizeWarning.classList.remove('hidden');
                } else {
                    imageSizeWarning.classList.add('hidden');
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    previewContainer.classList.remove('image-placeholder');
                    previewContainer.innerHTML = `<img src="${event.target.result}" class="image-preview" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            });
            
            // Add new item
            const addItemForm = document.getElementById('add-item-form');
            
            addItemForm?.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const nameInput = document.getElementById('item-name');
                const quantityInput = document.getElementById('item-quantity');
                const imageInput = document.getElementById('item-image');
                
                const name = nameInput.value.trim();
                const quantity = parseInt(quantityInput.value, 10);
                
                if (!name || isNaN(quantity)) {
                    return;
                }
                
                // Show loading state
                const loadingIndicator = document.getElementById('loading-indicator');
                loadingIndicator.classList.remove('hidden');
                
                // Process image
                processImage(imageInput.files[0]).then(imageData => {
                    // Create new item
                    const newItem = {
                        id: generateId(),
                        name,
                        quantity,
                        image: imageData,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Add to inventory
                    inventory.push(newItem);
                    
                    // Save to storage
                    saveInventory();
                    
                    // Update display
                    updateInventoryDisplay();
                    
                    // Reset form
                    addItemForm.reset();
                    previewContainer.innerHTML = '<span>Preview</span>';
                    previewContainer.classList.add('image-placeholder');
                    imageSizeWarning.classList.add('hidden');
                    
                    // Hide loading state
                    loadingIndicator.classList.add('hidden');
                    
                    // Show success toast
                    showToast('Item added successfully', 'success');
                }).catch(error => {
                    console.error('Error processing image:', error);
                    loadingIndicator.classList.add('hidden');
                    showToast('Error adding item: ' + error.message, 'error');
                });
            });
            
            // Tool buttons
            const exportDataBtn = document.getElementById('export-data');
            const importDataBtn = document.getElementById('import-data');
            const importFileInput = document.getElementById('import-file');
            const clearDataBtn = document.getElementById('clear-data');
            const shareDataBtn = document.getElementById('share-data');
            
            exportDataBtn?.addEventListener('click', exportInventory);
            importDataBtn?.addEventListener('click', () => importFileInput.click());
            importFileInput?.addEventListener('change', importInventory);
            clearDataBtn?.addEventListener('click', () => {
                showConfirmModal(
                    'Clear All Data',
                    'Are you sure you want to delete all inventory data? This action cannot be undone.',
                    clearInventory
                );
            });
            shareDataBtn?.addEventListener('click', shareData);
        };

        // Process image - resize and compress for storage efficiency
        const processImage = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                
                // Check if it's an image
                if (!file.type.startsWith('image/')) {
                    reject(new Error('Please select a valid image file'));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        // Determine if resizing is needed
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                            if (width > height) {
                                height = Math.round((height * MAX_IMAGE_DIMENSION) / width);
                                width = MAX_IMAGE_DIMENSION;
                            } else {
                                width = Math.round((width * MAX_IMAGE_DIMENSION) / height);
                                height = MAX_IMAGE_DIMENSION;
                            }
                        }
                        
                        // Create canvas for resizing
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw and compress
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to JPEG for better compression
                        const dataUrl = canvas.toDataURL('image/jpeg', IMAGE_QUALITY);
                        
                        // Check final size
                        const approximateSize = Math.round((dataUrl.length * 3) / 4) - 
                                              (dataUrl.indexOf(',') + 1);
                                              
                        if (approximateSize > 1024 * 1024) { // > 1MB
                            showToast('Image compressed but still large. Storage may be limited.', 'warning');
                        }
                        
                        resolve(dataUrl);
                    };
                    
                    img.onerror = () => {
                        reject(new Error('Error loading image'));
                    };
                    
                    img.src = event.target.result;
                };
                
                reader.onerror = () => {
                    reject(new Error('Error reading file'));
                };
                
                reader.readAsDataURL(file);
            });
        };

        // Update item quantity
        const updateItemQuantity = (id, change) => {
            const index = inventory.findIndex(item => item.id === id);
            if (index !== -1) {
                const newQuantity = Math.max(0, inventory[index].quantity + change);
                inventory[index].quantity = newQuantity;
                
                // Update display
                const quantityElement = document.querySelector(`#item-${id} .item-quantity`);
                if (quantityElement) {
                    quantityElement.textContent = newQuantity;
                    quantityElement.classList.add('quantity-changed');
                    setTimeout(() => {
                        quantityElement.classList.remove('quantity-changed');
                    }, 300);
                }
                
                if (newQuantity === 0) {
                    const itemElement = document.getElementById(`item-${id}`);
                    if (itemElement) {
                        itemElement.classList.add('bg-red-100', 'dark:bg-red-900', 'border-red-300');
                    }
                }
                
                // Save changes to storage
                saveInventory();
            }
        };

        // Delete item
        const deleteItem = (id) => {
            const index = inventory.findIndex(item => item.id === id);
            if (index !== -1) {
                inventory.splice(index, 1);
                // Save changes to storage
                saveInventory();
                updateInventoryDisplay();
                showToast('Item deleted', 'info');
            }
        };

        // Update inventory display
        const updateInventoryDisplay = () => {
            const inventoryGrid = document.getElementById('inventory-grid');
            const noItemsMessage = document.getElementById('no-items-message');
            const itemCount = document.getElementById('item-count');
            
            if (!inventoryGrid || !noItemsMessage || !itemCount) return;
            
            // Update item count
            itemCount.textContent = `${inventory.length} item${inventory.length !== 1 ? 's' : ''}`;
            
            // Show/hide no items message
            if (inventory.length === 0) {
                noItemsMessage.classList.remove('hidden');
                inventoryGrid.innerHTML = '';
                return;
            } else {
                noItemsMessage.classList.add('hidden');
            }
            
            // Clear and rebuild inventory grid
            inventoryGrid.innerHTML = '';
            
            // Sort inventory (newest first)
            const sortedInventory = [...inventory].sort((a, b) => {
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            // Add items to grid
            sortedInventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.id = `item-${item.id}`;
                itemElement.className = 'item-card rounded-lg shadow-md overflow-hidden new-item';
                
                const imageHtml = item.image 
                    ? `<img src="${item.image}" alt="${item.name}" class="w-full h-40 object-cover">`
                    : `<div class="w-full h-40 bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-500 dark:text-gray-400">
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                      </div>`;
                
                itemElement.innerHTML = `
                    ${imageHtml}
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold">${item.name}</h3>
                            <button class="delete-btn text-red-500 hover:text-red-700 transition" data-id="${item.id}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex items-center">
                                <button class="decrement-btn p-1 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition" data-id="${item.id}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                    </svg>
                                </button>
                                <span class="item-quantity text-lg font-bold mx-3 min-w-[20px] text-center">${item.quantity}</span>
                                <button class="increment-btn p-1 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition" data-id="${item.id}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                in stock
                            </div>
                        </div>
                    </div>
                `;
                
                inventoryGrid.appendChild(itemElement);
                
                // Remove new-item class after animation completes
                setTimeout(() => {
                    itemElement.classList.remove('new-item');
                }, 300);
            });
            
            // Add event listeners for buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    showConfirmModal(
                        'Delete Item',
                        'Are you sure you want to delete this item?',
                        () => deleteItem(id)
                    );
                });
            });
            
            document.querySelectorAll('.increment-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    updateItemQuantity(id, 1);
                });
            });
            
            document.querySelectorAll('.decrement-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    updateItemQuantity(id, -1);
                });
            });
        };

        // Show toast notification
        const showToast = (message, type = 'info') => {
            // Remove existing toast if present
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Clear timeout if exists
            if (toastTimeout) {
                clearTimeout(toastTimeout);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Icon based on type
            let icon = '';
            switch (type) {
                case 'success':
                    icon = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
                    break;
                case 'error':
                    icon = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
                    break;
                case 'warning':
                    icon = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
                    break;
                default:
                    icon = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1v-3a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
            }
            
            toast.innerHTML = `
                ${icon}
                <span>${message}</span>
            `;
            
            // Add to DOM
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Remove after 3 seconds
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        };

        // Show confirmation modal
        const showConfirmModal = (title, message, onConfirm) => {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            overlay.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-xl font-semibold mb-2">${title}</h3>
                    <p class="mb-6">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                            Cancel
                        </button>
                        <button id="modal-confirm" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">
                            Confirm
                        </button>
                    </div>
                </div>
            `;
            
            // Add to DOM
            document.body.appendChild(overlay);
            
            // Trigger animation
            setTimeout(() => {
                overlay.classList.add('show');
            }, 10);
            
            // Set up event listeners
            const cancelBtn = document.getElementById('modal-cancel');
            const confirmBtn = document.getElementById('modal-confirm');
            
            const closeModal = () => {
                overlay.classList.remove('show');
                setTimeout(() => {
                    overlay.remove();
                }, 300);
            };
            
            cancelBtn.addEventListener('click', closeModal);
            
            confirmBtn.addEventListener('click', () => {
                closeModal();
                onConfirm();
            });
        };

        // Export inventory
        const exportInventory = () => {
            if (inventory.length === 0) {
                showToast('No inventory data to export', 'warning');
                return;
            }
            
            try {
                const dataStr = JSON.stringify(inventory, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileName = `inventory_export_${new Date().toISOString().split('T')[0]}.json`;
                
                // Create link and trigger download
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.style.display = 'none';
                
                document.body.appendChild(linkElement);
                linkElement.click();
                document.body.removeChild(linkElement);
                
                showToast('Inventory exported successfully', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting inventory data', 'error');
            }
        };

        // Import inventory
        const importInventory = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedData)) {
                        throw new Error('Invalid inventory data format');
                    }
                    
                    showConfirmModal(
                        'Import Inventory',
                        `This will add ${importedData.length} items to your inventory. Continue?`,
                        () => {
                            // Add imported items
                            importedData.forEach(item => {
                                // Ensure each item has the required fields
                                if (!item.id) item.id = generateId();
                                if (!item.createdAt) item.createdAt = new Date().toISOString();
                                
                                // Add to inventory
                                inventory.push(item);
                            });
                            
                            // Save and update
                            saveInventory();
                            updateInventoryDisplay();
                            
                            showToast(`Imported ${importedData.length} items successfully`, 'success');
                        }
                    );
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Error importing inventory data: ' + error.message, 'error');
                }
            };
            
            reader.onerror = () => {
                showToast('Error reading file', 'error');
            };
            
            reader.readAsText(file);
            
            // Reset the file input so the same file can be selected again
            event.target.value = '';
        };

        // Clear inventory
        const clearInventory = () => {
            inventory = [];
            saveInventory();
            updateInventoryDisplay();
            showToast('All inventory data cleared', 'info');
        };
    </script>
</body>
</html>
