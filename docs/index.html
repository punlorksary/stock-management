<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A lightweight, browser-based inventory management system for tracking stock items with names, quantities, and images.">
    <title>Stock Management</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.0/flowbite.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.0/flowbite.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #5D5CDE;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #181818;
                --text-color: #ffffff;
                --card-bg: #2d2d2d;
                --input-bg: #3d3d3d;
            }
        }
        
        @media (prefers-color-scheme: light) {
            :root {
                --bg-color: #ffffff;
                --text-color: #333333;
                --card-bg: #f5f5f5;
                --input-bg: #ffffff;
            }
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .item-card {
            background-color: var(--card-bg);
        }
        
        .custom-file-upload {
            display: inline-block;
            padding: 8px 16px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            border-radius: 0.375rem;
            transition: background-color 0.3s;
        }
        
        .custom-file-upload:hover {
            background-color: #4b4abf;
        }
        
        /* Highlighted Add Item button */
        #add-item-form button[type="submit"] {
            position: relative;
            overflow: hidden;
            border: 2px solid #4b4abf;
            transition: all 0.3s ease;
            transform: translateY(0);
            box-shadow: 0 4px 6px rgba(93, 92, 222, 0.25);
        }
        
        #add-item-form button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(93, 92, 222, 0.3);
        }
        
        #add-item-form button[type="submit"]::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            bottom: -50%;
            left: -50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.1) 100%);
            transform: rotateZ(60deg) translate(-5em, 7.5em);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% {
                transform: rotateZ(60deg) translate(-5em, 7.5em);
            }
            100% {
                transform: rotateZ(60deg) translate(1em, -9em);
            }
        }
        
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .image-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e2e2e2;
            color: #666;
            font-size: 14px;
        }
        
        .image-preview {
            object-fit: cover;
            width: 100%;
            height: 100%;
        }
        
        /* Animation for new items */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .new-item {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Animation for quantity change */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .quantity-changed {
            animation: pulse 0.3s ease-out;
            color: var(--primary-color);
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .toast-error {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        
        .toast-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .toast-info {
            background-color: #e0f7ff;
            color: #0369a1;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: var(--bg-color);
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        
        .action-button-container {
            background-color: var(--card-bg);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            margin-top: 16px;
            border-radius: 0 0 8px 8px;
        }

        /* Cloud sync indicator */
        .sync-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .sync-online {
            background-color: #d1fae5;
            color: #065f46;
        }

        .sync-offline {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .sync-syncing {
            background-color: #fef3c7;
            color: #92400e;
        }

        /* Sync setup modal */
        .sync-setup-container {
            margin-top: 16px;
        }

        .sync-setup-container input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .sync-id-display {
            background-color: #f1f5f9;
            padding: 8px;
            border-radius: 6px;
            font-family: monospace;
            margin-bottom: 12px;
            word-break: break-all;
        }

        /* Get started section */
        .get-started-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .get-started-option:hover {
            border-color: var(--primary-color);
            background-color: rgba(93, 92, 222, 0.05);
        }
        
        .get-started-option svg {
            width: 2rem;
            height: 2rem;
            color: var(--primary-color);
            margin-right: 1rem;
        }
        
        .get-started-option-content h3 {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .get-started-option-content p {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        /* Authentication Form */
        .auth-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 2rem;
            border-radius: 0.5rem;
            background-color: var(--card-bg);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .auth-form input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 1rem;
        }
        
        .auth-form button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.25rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .auth-form button:hover {
            background-color: #4b4abf;
        }
        
        .auth-toggle {
            margin-top: 1rem;
            text-align: center;
            font-size: 0.875rem;
        }
        
        .auth-toggle button {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0;
            font-size: 0.875rem;
        }
        
        .auth-toggle button:hover {
            text-decoration: underline;
        }
        
        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            background-color: var(--card-bg);
            transition: background-color 0.2s;
        }
        
        .user-profile:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .user-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .user-profile-info {
            overflow: hidden;
        }
        
        .user-email {
            font-size: 0.75rem;
            color: #6b7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        /* Sync indicators */
        .sync-indicator {
            display: inline-flex;
            align-items: center;
            margin-left: 0.5rem;
            font-size: 0.75rem;
        }
        
        .sync-indicator svg {
            margin-right: 0.25rem;
        }
        
        .sync-success {
            color: #10b981;
        }
        
        .sync-pending {
            color: #f59e0b;
        }
        
        .sync-error {
            color: #ef4444;
        }

        /* Firebase Setup Form */
        .firebase-setup-form {
            max-width: 600px;
            margin: 0 auto;
            padding: 2rem;
            border-radius: 0.5rem;
            background-color: var(--card-bg);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .firebase-setup-form h2 {
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .firebase-setup-form p {
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .firebase-setup-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .firebase-setup-form input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        
        .firebase-setup-form .field-group {
            margin-bottom: 1.5rem;
        }
        
        .firebase-setup-form .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }
        
        .firebase-setup-steps {
            background-color: rgba(93, 92, 222, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .firebase-setup-steps ol {
            padding-left: 1.5rem;
            list-style-type: decimal;
        }
        
        .firebase-setup-steps li {
            margin-bottom: 0.5rem;
        }

        /* Toggle for local/cloud storage */
        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background-color: rgba(93, 92, 222, 0.05);
            border-radius: 0.5rem;
        }
        
        .toggle-track {
            position: relative;
            display: inline-block;
            width: 3.5rem;
            height: 1.75rem;
            margin: 0 0.75rem;
        }
        
        .toggle-track input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 1.75rem;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.25rem;
            width: 1.25rem;
            left: 0.25rem;
            bottom: 0.25rem;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(1.75rem);
        }
        
        .toggle-label {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <div id="firebase-setup-container">
            <!-- Firebase setup form will be inserted here -->
        </div>
        
        <div id="auth-container" class="hidden">
            <!-- Authentication form will be inserted here -->
        </div>
        
        <div id="app-container" class="hidden">
            <header class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">Stock Management</h1>
                <div class="flex items-center">
                    <div id="sync-status" class="sync-status sync-offline mr-2">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" transform="rotate(180, 10, 10)"></path>
                        </svg>
                        <span id="sync-text">Offline</span>
                    </div>
                    <div class="user-profile" id="user-profile">
                        <div class="user-avatar" id="user-avatar"></div>
                        <div class="user-profile-info">
                            <div class="user-name" id="user-name">User</div>
                            <div class="user-email" id="user-email"></div>
                        </div>
                    </div>
                    <button id="logout-btn" class="ml-2 p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </button>
                </div>
            </header>
            
            <!-- Add Item Form -->
            <div class="mb-8 p-6 rounded-lg shadow-md item-card">
                <h2 class="text-xl font-semibold mb-4">Add New Item</h2>
                <form id="add-item-form" class="space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label for="item-name" class="block mb-2 text-sm font-medium">Item Name</label>
                            <input type="text" id="item-name" class="bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white text-base rounded-lg focus:ring-primary focus:border-primary block w-full p-3" placeholder="Enter item name" required>
                        </div>
                        
                        <div>
                            <label for="item-quantity" class="block mb-2 text-sm font-medium">Quantity</label>
                            <input type="number" id="item-quantity" min="0" class="bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white text-base rounded-lg focus:ring-primary focus:border-primary block w-full p-3" placeholder="Enter quantity" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block mb-2 text-sm font-medium">Item Image</label>
                        <div class="flex items-center space-x-4">
                            <div id="image-preview-container" class="h-24 w-24 rounded-lg overflow-hidden image-placeholder">
                                <span>Preview</span>
                            </div>
                            <div>
                                <label for="item-image" class="custom-file-upload">
                                    <svg class="w-4 h-4 inline-block mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                                    </svg>
                                    Upload Image
                                </label>
                                <input type="file" id="item-image" accept="image/*">
                                <p class="text-xs mt-1 text-gray-500 dark:text-gray-400">Optional. PNG, JPG or GIF</p>
                                <p id="image-size-warning" class="text-xs mt-1 text-red-500 hidden">Warning: Large images may cause storage issues</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-button-container bg-gray-50 dark:bg-gray-800 rounded-lg p-4 mt-6">
                        <button type="submit" class="w-full px-5 py-3 text-base font-medium text-center text-white bg-[var(--primary-color)] rounded-lg hover:bg-[#4b4abf] focus:ring-4 focus:outline-none focus:ring-blue-300 transition flex items-center justify-center">
                            <span id="loading-indicator" class="hidden">
                                <span class="loader"></span>
                            </span>
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Item to Inventory
                        </button>
                        <div class="mt-2 text-sm text-center text-gray-500">Fill out the form above and click this button to add a new item</div>
                    </div>
                </form>
            </div>
            
            <!-- Inventory Display -->
            <div class="mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                    <h2 class="text-xl font-semibold">Current Inventory</h2>
                    <div class="flex flex-col md:flex-row items-start md:items-center gap-2">
                        <div id="storage-status" class="text-xs font-medium px-3 py-1 bg-yellow-100 text-yellow-800 rounded-md flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            Checking storage...
                        </div>
                        <div id="item-count" class="text-sm font-medium px-3 py-1 bg-[var(--primary-color)] text-white rounded-full">
                            0 items
                        </div>
                    </div>
                </div>
                
                <div id="no-items-message" class="text-center py-8 item-card rounded-lg">
                    <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                    </svg>
                    <p class="mt-4 text-gray-500 dark:text-gray-400">Your inventory is empty.</p>
                    
                    <!-- Get Started Section -->
                    <div class="mt-8 max-w-md mx-auto">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-300">Get Started</h3>
                        
                        <div class="get-started-option" id="option-add-items">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            <div class="get-started-option-content">
                                <h3>Add Items Manually</h3>
                                <p>Start by adding new items to your inventory</p>
                            </div>
                        </div>
                        
                        <div class="get-started-option" id="option-demo-data">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                            </svg>
                            <div class="get-started-option-content">
                                <h3>Load Demo Data</h3>
                                <p>Try out the app with sample inventory items</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="inventory-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Items will be added here dynamically -->
                </div>
            </div>
            
            <!-- Tools -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Tools</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="export-data" class="p-4 rounded-lg shadow-md bg-green-100 text-green-800 hover:bg-green-200 transition flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Export Data
                    </button>
                    
                    <div class="relative">
                        <input type="file" id="import-file" class="hidden" accept=".json">
                        <button id="import-data" class="p-4 w-full rounded-lg shadow-md bg-blue-100 text-blue-800 hover:bg-blue-200 transition flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" transform="rotate(180, 10, 10)"></path>
                            </svg>
                            Import Data
                        </button>
                    </div>
                    
                    <button id="clear-data" class="p-4 rounded-lg shadow-md bg-red-100 text-red-800 hover:bg-red-200 transition flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        Clear All Data
                    </button>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="text-center text-gray-500 text-sm mt-8 pb-6">
                <p>Stock Management App &copy; 2023</p>
                <p class="mt-1">
                    <a href="#" id="firebase-config-link" class="text-[var(--primary-color)] hover:underline">Firebase Configuration</a>
                </p>
            </footer>
        </div>
    </div>

    <script>
        // Constants
        const IMAGE_QUALITY = 0.7; // JPEG compression quality
        const MAX_IMAGE_DIMENSION = 800; // Maximum width or height for images
        const LOCAL_STORAGE_KEY = 'stockInventory_local';
        const FIREBASE_CONFIG_KEY = 'firebase_config';
        const STORAGE_MODE_KEY = 'storage_mode';

        // State
        let inventory = [];
        let currentUser = null;
        let isOnline = navigator.onLine;
        let pendingChanges = [];
        let isSyncing = false;
        let localStorageAvailable = false;
        let toastTimeout = null;
        let firebase = null;
        let auth = null;
        let database = null;
        let storage = null;
        let storageMode = 'local'; // 'local' or 'cloud'
        
        // Demo data
        const DEMO_INVENTORY = [
            {
                id: 'demo1',
                name: 'Notebook A5',
                quantity: 15,
                createdAt: new Date().toISOString(),
                image: null,
                syncStatus: 'synced'
            },
            {
                id: 'demo2',
                name: 'Blue Pens (Box)',
                quantity: 8,
                createdAt: new Date().toISOString(),
                image: null,
                syncStatus: 'synced'
            },
            {
                id: 'demo3',
                name: 'Desk Lamp',
                quantity: 3,
                createdAt: new Date().toISOString(),
                image: null,
                syncStatus: 'synced'
            },
            {
                id: 'demo4',
                name: 'USB Cable',
                quantity: 12,
                createdAt: new Date().toISOString(),
                image: null,
                syncStatus: 'synced'
            },
            {
                id: 'demo5',
                name: 'Coffee Mug',
                quantity: 5,
                createdAt: new Date().toISOString(),
                image: null,
                syncStatus: 'synced'
            },
            {
                id: 'demo6',
                name: 'Wireless Mouse',
                quantity: 2,
                createdAt: new Date().toISOString(),
                image: null,
                syncStatus: 'synced'
            }
        ];

        // DOM ready handler
        document.addEventListener('DOMContentLoaded', () => {
            checkLocalStorageAvailability();
            loadStorageMode();
            setupNetworkListeners();
            initializeApp();
        });
        
        // Load the storage mode from local storage
        const loadStorageMode = () => {
            if (localStorageAvailable) {
                const savedMode = localStorage.getItem(STORAGE_MODE_KEY);
                if (savedMode) {
                    storageMode = savedMode;
                }
            }
        };
        
        // Save the storage mode to local storage
        const saveStorageMode = (mode) => {
            if (localStorageAvailable) {
                localStorage.setItem(STORAGE_MODE_KEY, mode);
            }
        };
        
        // Initialize the app based on saved configuration
        const initializeApp = () => {
            if (localStorageAvailable) {
                const firebaseConfig = localStorage.getItem(FIREBASE_CONFIG_KEY);
                
                if (firebaseConfig && storageMode === 'cloud') {
                    // Try to initialize Firebase with saved config
                    try {
                        initializeFirebase(JSON.parse(firebaseConfig));
                        setupAuthUI();
                        
                        // Check if user is already logged in
                        auth.onAuthStateChanged((user) => {
                            currentUser = user;
                            if (user) {
                                showApp();
                                updateUserProfile();
                                loadInventory();
                                setupEventListeners();
                            } else {
                                showAuth();
                            }
                        });
                    } catch (error) {
                        console.error('Error initializing Firebase:', error);
                        showFirebaseSetup();
                    }
                } else {
                    // No saved config, show setup
                    showFirebaseSetup();
                }
            } else {
                // Local storage not available, go straight to local mode
                storageMode = 'local';
                showApp();
                loadInventory();
                setupEventListeners();
            }
        };
        
        // Initialize Firebase with the provided config
        const initializeFirebase = (config) => {
            // Initialize the app if it's not already initialized
            if (!firebase) {
                firebase = window.firebase;
                firebase.initializeApp(config);
                
                // Initialize services
                auth = firebase.auth();
                database = firebase.database();
                storage = firebase.storage();
            }
        };
        
        // Check if local storage is available
        const checkLocalStorageAvailability = () => {
            try {
                const testKey = '__storage_test__';
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
                localStorageAvailable = true;
            } catch (e) {
                localStorageAvailable = false;
            }
        };
        
        // Setup network status listeners
        const setupNetworkListeners = () => {
            window.addEventListener('online', handleNetworkChange);
            window.addEventListener('offline', handleNetworkChange);
        };
        
        // Handle network status changes
        const handleNetworkChange = () => {
            isOnline = navigator.onLine;
            updateSyncStatus();
            
            if (isOnline && pendingChanges.length > 0 && currentUser && storageMode === 'cloud') {
                syncPendingChanges();
            }
        };
        
        // Show Firebase setup UI
        const showFirebaseSetup = () => {
            const setupContainer = document.getElementById('firebase-setup-container');
            
            setupContainer.innerHTML = `
                <div class="firebase-setup-form">
                    <h2 class="text-2xl font-bold">Stock Management Setup</h2>
                    
                    <div class="toggle-container">
                        <span class="toggle-label">Local Storage</span>
                        <label class="toggle-track">
                            <input type="checkbox" id="storage-mode-toggle" ${storageMode === 'cloud' ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Cloud Storage</span>
                    </div>
                    
                    <div id="local-storage-info" class="${storageMode === 'cloud' ? 'hidden' : ''}">
                        <p>You are using <strong>Local Storage mode</strong>. Your inventory data will be stored in your browser's local storage.</p>
                        <p>This means your data will <strong>NOT</strong> be available on other devices and will be lost if you clear your browser data.</p>
                        <button id="continue-local" class="w-full px-5 py-3 text-base font-medium text-center text-white bg-[var(--primary-color)] rounded-lg hover:bg-[#4b4abf] transition mt-4">
                            Continue with Local Storage
                        </button>
                    </div>
                    
                    <div id="firebase-setup-form" class="${storageMode === 'local' ? 'hidden' : ''}">
                        <p>To use cloud storage, you need to create a Firebase project and provide your configuration details.</p>
                        
                        <div class="firebase-setup-steps">
                            <h3 class="font-semibold mb-2">Setup Steps:</h3>
                            <ol>
                                <li>Go to <a href="https://console.firebase.google.com/" target="_blank" class="text-[var(--primary-color)] underline">Firebase Console</a></li>
                                <li>Click "Add Project" and follow the setup wizard</li>
                                <li>Once your project is created, click "Web" (</>) to add a web app</li>
                                <li>Register your app with any name and copy the configuration object</li>
                                <li>Paste the configuration values below</li>
                                <li>Go to "Authentication" in Firebase Console and enable Email/Password authentication</li>
                                <li>Go to "Realtime Database" and create a database in test mode</li>
                                <li>Go to "Storage" and create a storage bucket in test mode</li>
                            </ol>
                        </div>
                        
                        <div class="field-group">
                            <label for="firebase-api-key">API Key</label>
                            <input type="text" id="firebase-api-key" placeholder="AIzaSyC_..." required>
                            
                            <label for="firebase-auth-domain">Auth Domain</label>
                            <input type="text" id="firebase-auth-domain" placeholder="your-project.firebaseapp.com" required>
                            
                            <label for="firebase-database-url">Database URL</label>
                            <input type="text" id="firebase-database-url" placeholder="https://your-project-default-rtdb.firebaseio.com" required>
                            
                            <label for="firebase-project-id">Project ID</label>
                            <input type="text" id="firebase-project-id" placeholder="your-project" required>
                            
                            <label for="firebase-storage-bucket">Storage Bucket</label>
                            <input type="text" id="firebase-storage-bucket" placeholder="your-project.appspot.com" required>
                            
                            <label for="firebase-messaging-sender-id">Messaging Sender ID</label>
                            <input type="text" id="firebase-messaging-sender-id" placeholder="1234567890" required>
                            
                            <label for="firebase-app-id">App ID</label>
                            <input type="text" id="firebase-app-id" placeholder="1:1234567890:web:abcdef123456" required>
                        </div>
                        
                        <div class="btn-group">
                            <button id="test-firebase" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                Test Connection
                            </button>
                            <button id="save-firebase" class="px-4 py-2 bg-[var(--primary-color)] text-white rounded hover:bg-[#4b4abf] transition">
                                Save & Continue
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners
            const storageToggle = document.getElementById('storage-mode-toggle');
            const localStorageInfo = document.getElementById('local-storage-info');
            const firebaseSetupForm = document.getElementById('firebase-setup-form');
            const continueLocalBtn = document.getElementById('continue-local');
            const testFirebaseBtn = document.getElementById('test-firebase');
            const saveFirebaseBtn = document.getElementById('save-firebase');
            
            storageToggle.addEventListener('change', (e) => {
                const newMode = e.target.checked ? 'cloud' : 'local';
                storageMode = newMode;
                saveStorageMode(newMode);
                
                if (newMode === 'cloud') {
                    localStorageInfo.classList.add('hidden');
                    firebaseSetupForm.classList.remove('hidden');
                } else {
                    localStorageInfo.classList.remove('hidden');
                    firebaseSetupForm.classList.add('hidden');
                }
            });
            
            continueLocalBtn.addEventListener('click', () => {
                showApp();
                loadInventory();
                setupEventListeners();
            });
            
            testFirebaseBtn.addEventListener('click', async () => {
                const config = getFirebaseConfigFromForm();
                if (!config) return;
                
                testFirebaseBtn.disabled = true;
                testFirebaseBtn.textContent = 'Testing...';
                
                try {
                    // Initialize Firebase with the config
                    initializeFirebase(config);
                    
                    // Test connection by trying to get timestamp from Firebase
                    const connectedRef = database.ref(".info/connected");
                    const snapshot = await new Promise((resolve, reject) => {
                        connectedRef.once('value', resolve, reject);
                    });
                    
                    if (snapshot.val() === true) {
                        showToast('Firebase connection successful!', 'success');
                    } else {
                        showToast('Firebase connected but not authenticated. Check your config.', 'warning');
                    }
                } catch (error) {
                    console.error('Error testing Firebase connection:', error);
                    showToast(`Connection error: ${error.message}`, 'error');
                } finally {
                    testFirebaseBtn.disabled = false;
                    testFirebaseBtn.textContent = 'Test Connection';
                }
            });
            
            saveFirebaseBtn.addEventListener('click', () => {
                const config = getFirebaseConfigFromForm();
                if (!config) return;
                
                try {
                    // Save the config
                    if (localStorageAvailable) {
                        localStorage.setItem(FIREBASE_CONFIG_KEY, JSON.stringify(config));
                    }
                    
                    // Initialize Firebase
                    initializeFirebase(config);
                    
                    // Move to auth UI
                    setupAuthUI();
                    showAuth();
                    
                    showToast('Firebase configuration saved', 'success');
                } catch (error) {
                    console.error('Error saving Firebase config:', error);
                    showToast(`Error: ${error.message}`, 'error');
                }
            });
        };
        
        // Get Firebase config from form
        const getFirebaseConfigFromForm = () => {
            const apiKey = document.getElementById('firebase-api-key').value.trim();
            const authDomain = document.getElementById('firebase-auth-domain').value.trim();
            const databaseURL = document.getElementById('firebase-database-url').value.trim();
            const projectId = document.getElementById('firebase-project-id').value.trim();
            const storageBucket = document.getElementById('firebase-storage-bucket').value.trim();
            const messagingSenderId = document.getElementById('firebase-messaging-sender-id').value.trim();
            const appId = document.getElementById('firebase-app-id').value.trim();
            
            if (!apiKey || !authDomain || !databaseURL || !projectId || !storageBucket || !messagingSenderId || !appId) {
                showToast('Please fill in all Firebase configuration fields', 'error');
                return null;
            }
            
            return {
                apiKey,
                authDomain,
                databaseURL,
                projectId,
                storageBucket,
                messagingSenderId,
                appId
            };
        };
        
        // Setup authentication UI
        const setupAuthUI = () => {
            const authContainer = document.getElementById('auth-container');
            authContainer.innerHTML = `
                <div class="auth-form">
                    <h2 class="text-2xl font-bold mb-6 text-center">Stock Management</h2>
                    
                    <div id="login-form">
                        <h3 class="text-lg font-semibold mb-4">Log In</h3>
                        <input type="email" id="login-email" placeholder="Email" required>
                        <input type="password" id="login-password" placeholder="Password" required>
                        <button id="login-button" type="button">Log In</button>
                        
                        <div class="auth-toggle mt-4">
                            <p>Don't have an account? <button id="show-signup">Sign Up</button></p>
                        </div>
                    </div>
                    
                    <div id="signup-form" class="hidden">
                        <h3 class="text-lg font-semibold mb-4">Sign Up</h3>
                        <input type="email" id="signup-email" placeholder="Email" required>
                        <input type="password" id="signup-password" placeholder="Password (min 6 characters)" required>
                        <button id="signup-button" type="button">Sign Up</button>
                        
                        <div class="auth-toggle mt-4">
                            <p>Already have an account? <button id="show-login">Log In</button></p>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners
            document.getElementById('login-button').addEventListener('click', handleLogin);
            document.getElementById('signup-button').addEventListener('click', handleSignup);
            document.getElementById('show-signup').addEventListener('click', () => {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
            });
            document.getElementById('show-login').addEventListener('click', () => {
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            });
        };
        
        // Handle login
        const handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                // Auth state change will trigger onAuthStateChanged
            } catch (error) {
                console.error('Login error:', error);
                showToast(`Login failed: ${error.message}`, 'error');
            }
        };
        
        // Handle signup
        const handleSignup = async () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                // Auth state change will trigger onAuthStateChanged
            } catch (error) {
                console.error('Signup error:', error);
                showToast(`Signup failed: ${error.message}`, 'error');
            }
        };
        
        // Show authentication UI
        const showAuth = () => {
            document.getElementById('firebase-setup-container').classList.add('hidden');
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        };
        
        // Show app UI
        const showApp = () => {
            document.getElementById('firebase-setup-container').classList.add('hidden');
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // Hide or show user profile based on storage mode
            const userProfile = document.getElementById('user-profile');
            const logoutBtn = document.getElementById('logout-btn');
            const syncStatus = document.getElementById('sync-status');
            
            if (storageMode === 'local') {
                userProfile.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                syncStatus.classList.add('hidden');
            } else {
                userProfile.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                syncStatus.classList.remove('hidden');
            }
        };
        
        // Update user profile display
        const updateUserProfile = () => {
            if (!currentUser || storageMode !== 'cloud') return;
            
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const userEmail = document.getElementById('user-email');
            
            // Set user initial in avatar
            const initial = currentUser.email.charAt(0).toUpperCase();
            userAvatar.textContent = initial;
            
            // Set user name/email
            userName.textContent = currentUser.displayName || 'User';
            userEmail.textContent = currentUser.email;
            
            // Setup logout button
            document.getElementById('logout-btn').addEventListener('click', () => {
                auth.signOut().catch(error => {
                    console.error('Logout error:', error);
                    showToast(`Logout failed: ${error.message}`, 'error');
                });
            });
        };
        
        // Get items reference for the current user
        const getItemsRef = () => {
            if (!database || !currentUser) return null;
            return database.ref(`users/${currentUser.uid}/items`);
        };
        
        // Get storage reference for the current user
        const getStorageRef = () => {
            if (!storage || !currentUser) return null;
            return storage.ref(`users/${currentUser.uid}`);
        };
        
        // Load inventory from storage
        const loadInventory = async () => {
            if (storageMode === 'cloud' && currentUser && isOnline) {
                await loadFromCloud();
            } else {
                loadFromLocalStorage();
            }
            
            updateInventoryDisplay();
        };
        
        // Load inventory from Firebase
        const loadFromCloud = async () => {
            updateSyncStatus('syncing');
            
            try {
                const itemsRef = getItemsRef();
                
                if (itemsRef) {
                    const snapshot = await itemsRef.once('value');
                    const data = snapshot.val();
                    
                    if (data) {
                        // Convert object to array
                        inventory = Object.keys(data).map(key => ({
                            ...data[key],
                            syncStatus: 'synced'
                        }));
                        
                        // Load images
                        for (const item of inventory) {
                            if (item.hasImage) {
                                try {
                                    const imageUrl = await getStorageRef().child(`images/${item.id}`).getDownloadURL();
                                    item.image = imageUrl;
                                } catch (error) {
                                    console.warn(`Failed to load image for item ${item.id}:`, error);
                                    item.image = null;
                                }
                            }
                        }
                        
                        // Save to local storage as backup
                        saveToLocalStorage();
                        
                        updateSyncStatus('online');
                        showToast('Inventory loaded from cloud', 'success');
                    } else {
                        // No data in cloud, check local storage
                        loadFromLocalStorage();
                    }
                }
            } catch (error) {
                console.error('Error loading inventory from cloud:', error);
                showToast('Error loading inventory from cloud', 'error');
                
                // Fallback to local storage
                loadFromLocalStorage();
            }
        };
        
        // Load inventory from local storage
        const loadFromLocalStorage = () => {
            if (!localStorageAvailable) {
                inventory = [];
                return;
            }
            
            try {
                const localData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (localData) {
                    inventory = JSON.parse(localData);
                    updateSyncStatus('offline');
                } else {
                    inventory = [];
                }
            } catch (error) {
                console.error('Error loading from local storage:', error);
                inventory = [];
            }
        };
        
        // Save inventory to local storage
        const saveToLocalStorage = () => {
            if (!localStorageAvailable) return;
            
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(inventory));
            } catch (error) {
                console.error('Error saving to local storage:', error);
                showToast('Error saving to local storage', 'error');
            }
        };
        
        // Save inventory
        const saveInventory = async (item, changeType = 'add') => {
            // Always save to local storage for offline support
            saveToLocalStorage();
            
            if (storageMode === 'local') {
                // Just save locally
                return;
            }
            
            // Add to pending changes if offline
            if (!isOnline || !currentUser) {
                // Mark item as pending
                const itemIndex = inventory.findIndex(i => i.id === item.id);
                if (itemIndex !== -1) {
                    inventory[itemIndex].syncStatus = 'pending';
                }
                
                pendingChanges.push({
                    item,
                    changeType,
                    timestamp: Date.now()
                });
                
                updateSyncStatus('offline');
                updateInventoryDisplay();
                return;
            }
            
            // If online, sync immediately
            await syncItem(item, changeType);
        };
        
        // Sync a single item
        const syncItem = async (item, changeType) => {
            if (!currentUser || !isOnline || storageMode !== 'cloud') return false;
            
            const itemsRef = getItemsRef();
            if (!itemsRef) return false;
            
            updateSyncStatus('syncing');
            
            try {
                // Handle image separately
                let itemToSync = { ...item };
                const hasImage = item.image && item.image.startsWith('data:');
                
                if (hasImage) {
                    // It's a data URL, need to upload
                    const imageRef = getStorageRef().child(`images/${item.id}`);
                    const imageBlob = await dataURLToBlob(item.image);
                    await imageRef.put(imageBlob);
                    
                    // Get the URL
                    const imageUrl = await imageRef.getDownloadURL();
                    
                    // Replace data URL with download URL
                    const itemIndex = inventory.findIndex(i => i.id === item.id);
                    if (itemIndex !== -1) {
                        inventory[itemIndex].image = imageUrl;
                    }
                    
                    // Don't store the image data in the database
                    itemToSync.image = null;
                    itemToSync.hasImage = true;
                } else if (item.image) {
                    // It's already a URL, just set hasImage flag
                    itemToSync.hasImage = true;
                    itemToSync.image = null; // Don't store the URL in the database
                } else {
                    // No image
                    itemToSync.hasImage = false;
                    itemToSync.image = null;
                }
                
                // Remove syncStatus from the data to save
                delete itemToSync.syncStatus;
                
                // Handle different change types
                if (changeType === 'delete') {
                    // Delete the item
                    await itemsRef.child(item.id).remove();
                    
                    // Delete the image if it exists
                    if (item.hasImage) {
                        try {
                            await getStorageRef().child(`images/${item.id}`).delete();
                        } catch (error) {
                            console.warn(`Failed to delete image for item ${item.id}:`, error);
                        }
                    }
                } else {
                    // Add or update the item
                    await itemsRef.child(item.id).set(itemToSync);
                }
                
                // Update the sync status in local inventory
                const itemIndex = inventory.findIndex(i => i.id === item.id);
                if (itemIndex !== -1 && changeType !== 'delete') {
                    inventory[itemIndex].syncStatus = 'synced';
                }
                
                updateSyncStatus('online');
                return true;
            } catch (error) {
                console.error('Error syncing item:', error);
                
                // Mark as pending
                const itemIndex = inventory.findIndex(i => i.id === item.id);
                if (itemIndex !== -1 && changeType !== 'delete') {
                    inventory[itemIndex].syncStatus = 'error';
                }
                
                updateSyncStatus('error');
                return false;
            }
        };
        
        // Sync all pending changes
        const syncPendingChanges = async () => {
            if (!currentUser || !isOnline || pendingChanges.length === 0 || isSyncing || storageMode !== 'cloud') return;
            
            isSyncing = true;
            updateSyncStatus('syncing');
            
            // Create a copy of pending changes since we'll be modifying the array
            const changesToProcess = [...pendingChanges];
            pendingChanges = [];
            
            for (const change of changesToProcess) {
                try {
                    const success = await syncItem(change.item, change.changeType);
                    
                    if (!success) {
                        // Add back to pending changes
                        pendingChanges.push(change);
                    }
                } catch (error) {
                    console.error('Error processing pending change:', error);
                    pendingChanges.push(change);
                }
            }
            
            isSyncing = false;
            
            // Update sync status based on remaining pending changes
            if (pendingChanges.length > 0) {
                updateSyncStatus('error');
                showToast(`${pendingChanges.length} changes failed to sync`, 'warning');
            } else {
                updateSyncStatus('online');
                showToast('All changes synced successfully', 'success');
            }
            
            updateInventoryDisplay();
        };
        
        // Update sync status display
        const updateSyncStatus = (status = null) => {
            if (storageMode !== 'cloud') return;
            
            const syncStatus = document.getElementById('sync-status');
            const syncText = document.getElementById('sync-text');
            
            if (!syncStatus || !syncText) return;
            
            // Determine status if not provided
            if (status === null) {
                if (!isOnline) {
                    status = 'offline';
                } else if (pendingChanges.length > 0) {
                    status = 'pending';
                } else if (currentUser) {
                    status = 'online';
                } else {
                    status = 'offline';
                }
            }
            
            // Update display based on status
            syncStatus.className = 'sync-status';
            
            switch (status) {
                case 'online':
                    syncStatus.classList.add('sync-online');
                    syncText.textContent = 'Cloud Synced';
                    syncStatus.innerHTML = `
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span id="sync-text">Cloud Synced</span>
                    `;
                    break;
                case 'offline':
                    syncStatus.classList.add('sync-offline');
                    syncText.textContent = 'Offline';
                    syncStatus.innerHTML = `
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" transform="rotate(180, 10, 10)"></path>
                        </svg>
                        <span id="sync-text">Offline</span>
                    `;
                    break;
                case 'syncing':
                    syncStatus.classList.add('sync-syncing');
                    syncText.textContent = 'Syncing...';
                    syncStatus.innerHTML = `
                        <div class="loader mr-1"></div>
                        <span id="sync-text">Syncing...</span>
                    `;
                    break;
                case 'pending':
                    syncStatus.classList.add('sync-syncing');
                    syncText.textContent = `${pendingChanges.length} Pending`;
                    syncStatus.innerHTML = `
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                        </svg>
                        <span id="sync-text">${pendingChanges.length} Pending</span>
                    `;
                    break;
                case 'error':
                    syncStatus.classList.add('sync-offline');
                    syncText.textContent = 'Sync Error';
                    syncStatus.innerHTML = `
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span id="sync-text">Sync Error</span>
                    `;
                    break;
            }
        };
        
        // Convert data URL to Blob
        const dataURLToBlob = (dataURL) => {
            const parts = dataURL.split(';base64,');
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;
            const uInt8Array = new Uint8Array(rawLength);
            
            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }
            
            return new Blob([uInt8Array], { type: contentType });
        };
        
        // Set up event listeners
        const setupEventListeners = () => {
            // Image preview
            const imageInput = document.getElementById('item-image');
            const previewContainer = document.getElementById('image-preview-container');
            const imageSizeWarning = document.getElementById('image-size-warning');
            
            imageInput?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) {
                    previewContainer.innerHTML = '<span>Preview</span>';
                    previewContainer.classList.add('image-placeholder');
                    imageSizeWarning.classList.add('hidden');
                    return;
                }
                
                // Check file size
                if (file.size > 2 * 1024 * 1024) { // 2MB
                    imageSizeWarning.classList.remove('hidden');
                } else {
                    imageSizeWarning.classList.add('hidden');
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    previewContainer.classList.remove('image-placeholder');
                    previewContainer.innerHTML = `<img src="${event.target.result}" class="image-preview" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            });
            
            // Add new item
            const addItemForm = document.getElementById('add-item-form');
            
            addItemForm?.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const nameInput = document.getElementById('item-name');
                const quantityInput = document.getElementById('item-quantity');
                const imageInput = document.getElementById('item-image');
                
                const name = nameInput.value.trim();
                const quantity = parseInt(quantityInput.value, 10);
                
                if (!name || isNaN(quantity)) {
                    return;
                }
                
                // Show loading state
                const loadingIndicator = document.getElementById('loading-indicator');
                loadingIndicator.classList.remove('hidden');
                
                // Process image
                processImage(imageInput.files[0]).then(imageData => {
                    // Create new item
                    const newItem = {
                        id: generateId(),
                        name,
                        quantity,
                        image: imageData,
                        createdAt: new Date().toISOString(),
                        syncStatus: storageMode === 'cloud' ? 'pending' : 'synced'
                    };
                    
                    // Add to inventory
                    inventory.push(newItem);
                    
                    // Save to storage
                    saveInventory(newItem, 'add');
                    
                    // Update display
                    updateInventoryDisplay();
                    
                    // Reset form
                    addItemForm.reset();
                    previewContainer.innerHTML = '<span>Preview</span>';
                    previewContainer.classList.add('image-placeholder');
                    imageSizeWarning.classList.add('hidden');
                    
                    // Hide loading state
                    loadingIndicator.classList.add('hidden');
                    
                    // Show success toast
                    showToast('Item added successfully', 'success');
                }).catch(error => {
                    console.error('Error processing image:', error);
                    loadingIndicator.classList.add('hidden');
                    showToast('Error adding item: ' + error.message, 'error');
                });
            });
            
            // Tool buttons
            const exportDataBtn = document.getElementById('export-data');
            const importDataBtn = document.getElementById('import-data');
            const importFileInput = document.getElementById('import-file');
            const clearDataBtn = document.getElementById('clear-data');
            const firebaseConfigLink = document.getElementById('firebase-config-link');
            
            exportDataBtn?.addEventListener('click', exportInventory);
            importDataBtn?.addEventListener('click', () => importFileInput.click());
            importFileInput?.addEventListener('change', importInventory);
            clearDataBtn?.addEventListener('click', () => {
                showConfirmModal(
                    'Clear All Data',
                    'Are you sure you want to delete all inventory data? This action cannot be undone.',
                    clearInventory
                );
            });
            
            firebaseConfigLink?.addEventListener('click', (e) => {
                e.preventDefault();
                showFirebaseSetup();
            });
            
            // Get Started options
            const addItemsOption = document.getElementById('option-add-items');
            const demoDataOption = document.getElementById('option-demo-data');
            
            addItemsOption?.addEventListener('click', () => {
                // Scroll to add item form
                const addItemForm = document.getElementById('add-item-form');
                const nameInput = document.getElementById('item-name');
                addItemForm.scrollIntoView({ behavior: 'smooth' });
                setTimeout(() => {
                    nameInput.focus();
                }, 500);
            });
            demoDataOption?.addEventListener('click', loadDemoData);
        };
        
        // Process image - resize and compress for storage efficiency
        const processImage = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                
                // Check if it's an image
                if (!file.type.startsWith('image/')) {
                    reject(new Error('Please select a valid image file'));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        // Determine if resizing is needed
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                            if (width > height) {
                                height = Math.round((height * MAX_IMAGE_DIMENSION) / width);
                                width = MAX_IMAGE_DIMENSION;
                            } else {
                                width = Math.round((width * MAX_IMAGE_DIMENSION) / height);
                                height = MAX_IMAGE_DIMENSION;
                            }
                        }
                        
                        // Create canvas for resizing
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw and compress
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to JPEG for better compression
                        const dataUrl = canvas.toDataURL('image/jpeg', IMAGE_QUALITY);
                        
                        // Check final size
                        const approximateSize = Math.round((dataUrl.length * 3) / 4) - 
                                            (dataUrl.indexOf(',') + 1);
                                            
                        if (approximateSize > 1024 * 1024) { // > 1MB
                            showToast('Image compressed but still large. Storage may be limited.', 'warning');
                        }
                        
                        resolve(dataUrl);
                    };
                    
                    img.onerror = () => {
                        reject(new Error('Error loading image'));
                    };
                    
                    img.src = event.target.result;
                };
                
                reader.onerror = () => {
                    reject(new Error('Error reading file'));
                };
                
                reader.readAsDataURL(file);
            });
        };
        
        // Update item quantity
        const updateItemQuantity = (id, change) => {
            const index = inventory.findIndex(item => item.id === id);
            if (index !== -1) {
                const newQuantity = Math.max(0, inventory[index].quantity + change);
                inventory[index].quantity = newQuantity;
                
                if (storageMode === 'cloud') {
                    inventory[index].syncStatus = 'pending';
                }
                
                // Update display
                const quantityElement = document.querySelector(`#item-${id} .item-quantity`);
                if (quantityElement) {
                    quantityElement.textContent = newQuantity;
                    quantityElement.classList.add('quantity-changed');
                    setTimeout(() => {
                        quantityElement.classList.remove('quantity-changed');
                    }, 300);
                }
                
                if (newQuantity === 0) {
                    const itemElement = document.getElementById(`item-${id}`);
                    if (itemElement) {
                        itemElement.classList.add('bg-red-100', 'dark:bg-red-900', 'border-red-300');
                    }
                }
                
                // Save changes to storage
                saveInventory(inventory[index], 'update');
            }
        };
        
        // Delete item
        const deleteItem = (id) => {
            const index = inventory.findIndex(item => item.id === id);
            if (index !== -1) {
                const itemToDelete = { ...inventory[index] };
                inventory.splice(index, 1);
                
                // Save changes to storage
                saveInventory(itemToDelete, 'delete');
                updateInventoryDisplay();
                showToast('Item deleted', 'info');
            }
        };
        
        // Update inventory display
        const updateInventoryDisplay = () => {
            const inventoryGrid = document.getElementById('inventory-grid');
            const noItemsMessage = document.getElementById('no-items-message');
            const itemCount = document.getElementById('item-count');
            
            if (!inventoryGrid || !noItemsMessage || !itemCount) return;
            
            // Update item count
            itemCount.textContent = `${inventory.length} item${inventory.length !== 1 ? 's' : ''}`;
            
            // Show/hide no items message
            if (inventory.length === 0) {
                noItemsMessage.classList.remove('hidden');
                inventoryGrid.innerHTML = '';
                return;
            } else {
                noItemsMessage.classList.add('hidden');
            }
            
            // Clear and rebuild inventory grid
            inventoryGrid.innerHTML = '';
            
            // Sort inventory (newest first)
            const sortedInventory = [...inventory].sort((a, b) => {
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            // Add items to grid
            sortedInventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.id = `item-${item.id}`;
                itemElement.className = 'item-card rounded-lg shadow-md overflow-hidden new-item';
                
                const imageHtml = item.image 
                    ? `<img src="${item.image}" alt="${item.name}" class="w-full h-40 object-cover">`
                    : `<div class="w-full h-40 bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-500 dark:text-gray-400">
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                      </div>`;
                
                // Create sync status indicator
                let syncIndicator = '';
                if (storageMode === 'cloud') {
                    if (item.syncStatus === 'pending') {
                        syncIndicator = `
                            <div class="sync-indicator sync-pending" title="Waiting to sync">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                        `;
                    } else if (item.syncStatus === 'error') {
                        syncIndicator = `
                            <div class="sync-indicator sync-error" title="Sync failed">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                        `;
                    } else {
                        syncIndicator = `
                            <div class="sync-indicator sync-success" title="Synced to cloud">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                        `;
                    }
                }
                
                itemElement.innerHTML = `
                    ${imageHtml}
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold flex items-center">
                                ${item.name}
                                ${syncIndicator}
                            </h3>
                            <button class="delete-btn text-red-500 hover:text-red-700 transition" data-id="${item.id}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex items-center">
                                <button class="decrement-btn p-1 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition" data-id="${item.id}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                    </svg>
                                </button>
                                <span class="item-quantity text-lg font-bold mx-3 min-w-[20px] text-center">${item.quantity}</span>
                                <button class="increment-btn p-1 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition" data-id="${item.id}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                in stock
                            </div>
                        </div>
                    </div>
                `;
                
                inventoryGrid.appendChild(itemElement);
                
                // Remove new-item class after animation completes
                setTimeout(() => {
                    itemElement.classList.remove('new-item');
                }, 300);
            });
            
            // Add event listeners for buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    showConfirmModal(
                        'Delete Item',
                        'Are you sure you want to delete this item?',
                        () => deleteItem(id)
                    );
                });
            });
            
            document.querySelectorAll('.increment-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    updateItemQuantity(id, 1);
                });
            });
            
            document.querySelectorAll('.decrement-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    updateItemQuantity(id, -1);
                });
            });
        };
        
        // Load demo data
        const loadDemoData = () => {
            const demoInventory = DEMO_INVENTORY.map(item => ({
                ...item,
                id: `demo_${generateId()}`
            }));
            
            if (inventory.length > 0) {
                showConfirmModal(
                    'Load Demo Data',
                    'This will add demo items to your existing inventory. Continue?',
                    () => {
                        // Add demo items
                        inventory = [...inventory, ...demoInventory];
                        
                        // Save each demo item
                        demoInventory.forEach(item => {
                            saveInventory(item, 'add');
                        });
                        
                        updateInventoryDisplay();
                        showToast('Demo data loaded successfully', 'success');
                    }
                );
            } else {
                // Add demo items
                inventory = [...demoInventory];
                
                // Save each demo item
                demoInventory.forEach(item => {
                    saveInventory(item, 'add');
                });
                
                updateInventoryDisplay();
                showToast('Demo data loaded successfully', 'success');
            }
        };
        
        // Show toast notification
        const showToast = (message, type = 'info') => {
            // Remove existing toast if present
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Clear timeout if exists
            if (toastTimeout) {
                clearTimeout(toastTimeout);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Icon based on type
            let icon = '';
            switch (type) {
                case 'success':
                    icon = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
                    break;
                case 'error':
                    icon = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
                    break;
                case 'warning':
                    icon = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
                    break;
                default:
                    icon = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1v-3a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
            }
            
            toast.innerHTML = `
                ${icon}
                <span>${message}</span>
            `;
            
            // Add to DOM
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Remove after 3 seconds
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        };
        
        // Show confirmation modal
        const showConfirmModal = (title, message, onConfirm) => {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            overlay.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-xl font-semibold mb-2">${title}</h3>
                    <p class="mb-6">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                            Cancel
                        </button>
                        <button id="modal-confirm" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">
                            Confirm
                        </button>
                    </div>
                </div>
            `;
            
            // Add to DOM
            document.body.appendChild(overlay);
            
            // Trigger animation
            setTimeout(() => {
                overlay.classList.add('show');
            }, 10);
            
            // Set up event listeners
            const cancelBtn = document.getElementById('modal-cancel');
            const confirmBtn = document.getElementById('modal-confirm');
            
            const closeModal = () => {
                overlay.classList.remove('show');
                setTimeout(() => {
                    overlay.remove();
                }, 300);
            };
            
            cancelBtn.addEventListener('click', closeModal);
            
            confirmBtn.addEventListener('click', () => {
                closeModal();
                onConfirm();
            });
        };
        
        // Export inventory
        const exportInventory = () => {
            if (inventory.length === 0) {
                showToast('No inventory data to export', 'warning');
                return;
            }
            
            try {
                const dataStr = JSON.stringify(inventory, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileName = `inventory_export_${new Date().toISOString().split('T')[0]}.json`;
                
                // Create link and trigger download
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.style.display = 'none';
                
                document.body.appendChild(linkElement);
                linkElement.click();
                document.body.removeChild(linkElement);
                
                showToast('Inventory exported successfully', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting inventory data', 'error');
            }
        };
        
        // Import inventory
        const importInventory = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedData)) {
                        throw new Error('Invalid inventory data format');
                    }
                    
                    showConfirmModal(
                        'Import Inventory',
                        `This will add ${importedData.length} items to your inventory. Continue?`,
                        async () => {
                            // Add imported items
                            for (const item of importedData) {
                                // Ensure each item has the required fields
                                const newItem = {
                                    id: item.id || generateId(),
                                    name: item.name,
                                    quantity: item.quantity || 0,
                                    image: item.image || null,
                                    createdAt: item.createdAt || new Date().toISOString(),
                                    syncStatus: storageMode === 'cloud' ? 'pending' : 'synced'
                                };
                                
                                // Add to inventory
                                inventory.push(newItem);
                                
                                // Save to storage
                                await saveInventory(newItem, 'add');
                            }
                            
                            // Update display
                            updateInventoryDisplay();
                            
                            showToast(`Imported ${importedData.length} items successfully`, 'success');
                        }
                    );
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Error importing inventory data: ' + error.message, 'error');
                }
            };
            
            reader.onerror = () => {
                showToast('Error reading file', 'error');
            };
            
            reader.readAsText(file);
            
            // Reset the file input so the same file can be selected again
            event.target.value = '';
        };
        
        // Clear inventory
        const clearInventory = async () => {
            if (storageMode === 'cloud' && currentUser && isOnline) {
                try {
                    updateSyncStatus('syncing');
                    
                    // Clear from cloud
                    await getItemsRef().remove();
                    
                    // Try to delete all images
                    for (const item of inventory) {
                        if (item.hasImage) {
                            try {
                                await getStorageRef().child(`images/${item.id}`).delete();
                            } catch (error) {
                                console.warn(`Failed to delete image for item ${item.id}:`, error);
                            }
                        }
                    }
                    
                    // Clear local inventory
                    inventory = [];
                    pendingChanges = [];
                    saveToLocalStorage();
                    updateInventoryDisplay();
                    
                    updateSyncStatus('online');
                    showToast('All inventory data cleared', 'info');
                } catch (error) {
                    console.error('Error clearing inventory:', error);
                    showToast('Error clearing inventory data', 'error');
                    updateSyncStatus('error');
                }
            } else {
                // Local mode or offline
                inventory = [];
                saveToLocalStorage();
                updateInventoryDisplay();
                showToast('All inventory data cleared', 'info');
            }
        };
        
        // Generate a unique ID
        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        };
        
        // Periodic sync check
        setInterval(() => {
            if (isOnline && pendingChanges.length > 0 && currentUser && !isSyncing && storageMode === 'cloud') {
                syncPendingChanges();
            }
        }, 30000); // Check every 30 seconds
    </script>
</body>
</html>
